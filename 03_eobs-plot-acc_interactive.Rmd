---
title: "Interactive plotting of e-obs acc and gps burst data"
output:
  html_document:
    toc: true
    toc_depth: 4
    theme: cerulean
    highlight: zenburn
---

	
# Set workspace

```{r global_options, include=FALSE}

# Global options
knitr::opts_chunk$set(fig.width=12, fig.height=8,
                      # fig.path=fig.path,
                      echo=TRUE, warning=FALSE, message=FALSE)

options(DT.options = list(pageLength = 25,
                          dom = 'Btip',
                          filter = "top",
                          extensions = 'Buttons',
                          buttons = c('copy', 'csv')))


 ```
 
```{r}

# ==============================================================================
# * Environment
# ==============================================================================
library(dplyr)
library(lubridate)
library(data.table)
library(plotly)
library(tidyr)
library(hrbrthemes)
library(cowplot)

source("R/00_fxns.R")

silent = TRUE # for lapply to run silently
sparse = TRUE # to plot a sample of the entire acc readings
sample_size = 500000

fig_path = "results/figs/acc_gps_plots"

```
# Load previously created plot info data

```{r}

plot_info = readRDS("data/acc-gps_plot-info_yz.RDS")

```

# Plot acc & gps data

```{r plot}

tagIDs = names(plot_info)

if(FALSE) {
    
    ID = tagIDs[1]
    
}


all_plots = lapply(tagIDs, function(ID, plot_info, sparse, silent, out_dir, sample_size) {

    if( !silent) cat("****", ID, "***\n")
    
    acc_df = plot_info[[ ID ]]$acc_df
    acc_plot = plot_info[[ ID ]]$acc_plot
    day_info = plot_info[[ ID ]]$day_info
    gps_acc_N = plot_info[[ ID ]]$gps_acc_N

    # Max value of any axis reading
    max_y = max(acc_plot$value + 200, na.rm = TRUE)

    # Get x axis labels
    x_lab = data.frame(n = c(day_info$start_n, day_info$end_n),
                       timestamp = c(day_info$start_ts, day_info$end_ts))

    x_lab = x_lab[ order(x_lab$n), ]

    
    x_lab$label = paste0(lubridate::month(x_lab$timestamp, label = TRUE),
                         lubridate::day(x_lab$timestamp),
                         "\n",
                         format(x_lab$timestamp, "%H:%M"))


    tdiff = difftime(x_lab$timestamp, lag(x_lab$timestamp), units = "hours")
    x_lab = x_lab[ tdiff >= 10 | is.na(tdiff), ]

    # Subset acc_df for test plots
    if(sparse) {

        s = sample(1:nrow(acc_plot), size = sample_size)
        acc_plot = acc_plot[ s, ]

    }

    
    p = ggplot() +
        geom_rect(data = day_info,
                  aes(xmin = start_n, xmax = end_n,
                      ymin = 0, ymax = max_y,
                      text = "Day"),
                  fill = "#F2F2F2") + 
        geom_line(data = acc_plot,
                  aes(x = n, y = value,
                      group = axis,
                      color = axis,
                      text = paste0(activity, "\n", timestamp)),
                  alpha = 0.6) +
        scale_color_manual(values=c("#D55E00", "#009E73", "#0072B2"),
                           labels = c("X", "Y", "Z")) +
        theme_ipsum(base_size = 10,
                    base_family = "Helvetica",
                    grid = FALSE,
                    axis_col = "#919191", axis = TRUE, ticks = TRUE) +
        scale_x_continuous(breaks = x_lab$n,
                           labels = x_lab$label) +
        ggtitle(paste0(ID, " interactive plot")) +
        labs(color = "Acceleration\naxis") +
        ylab("Acceleration\nreading") +
        xlab("Time") +
        theme(axis.title.y = element_text(angle = 0, hjust = 0, vjust = 0.5))
    
    static_p = p +  geom_segment(data = gps_acc_N[ gps_acc_N$activity %in% "NotFlying"],
                                 aes(x = n,
                                     y = (max_y + 100),
                                     xend = n,
                                     yend = (max_y + 200),
                                     text = paste0(activity, "\n", timestamp)),
                                 color = "#F2CB70") +
        geom_segment(data = gps_acc_N[ gps_acc_N$activity %in% "Flying"],
                     aes(x = n,
                         y = (max_y + 100),
                         xend = n,
                         yend = (max_y + 200),
                         text = paste0(activity, "\n", timestamp)),
                     color =  "#8C0C53")

    
    gps_l = data.frame(activity = c("GPS: Flying", "GPS: Not Flying"), n = 2) %>%
        ggplot(aes(activity, fill = activity)) +
        geom_bar() + scale_fill_manual(values=c("#8C0C53", "#F2CB70")) +
        theme(legend.position = "top",
              legend.justification='right',
              legend.key.size = unit(0.2, "cm"),
              legend.text=element_text(size = 8, family = "Helvetica")) +
        labs(fill = "")

    gps_l = get_legend(gps_l)

    day_l = data.frame(activity = "Day time", n = 2) %>%
        ggplot(aes(x = activity, fill = activity))+
        geom_bar() + scale_fill_manual(values="#F2F2F2") +
        theme(legend.position = "top",
              legend.justification='left',
              legend.key.size = unit(0.2, "cm"),
              legend.key.width = unit(0.6, "cm"),
              legend.text=element_text(size = 8, family = "Helvetica")) +
        labs(fill = "")

    day_l = get_legend(day_l)

    
    final_p = static_p +
        annotation_custom(grob = day_l, ymin = max_y + 300) +
        annotation_custom(grob = gps_l, ymin = max_y + 300)

    list(final_p = final_p, x_lab = x_lab)
    
}, plot_info, sparse = sparse, silent = silent, out_dir = out_dir, sample_size = sample_size)

names(all_plots) = tagIDs

```

```{r, results='asis', echo = TRUE}

saved_plots = file.path(here::here(),
                        list.files(fig_path, full.names = TRUE))


p_l = vector(mode = "list", length = 8)
l <- htmltools::tagList()

for (i in seq_along(all_plots)) {

    ind_p = all_plots[[ i ]]$final_p
    x_lab = all_plots[[ i ]]$x_lab

    plotly_p = ggplotly(ind_p, tooltip = "text") %>%
        layout(xaxis = list(
                           tickmode = "array",
                           nticks = 6,
                           tickvals = x_lab$n,
                           ticktext = x_lab$label),
               height = 500)

    p_l[[ i ]] = htmltools::tagList(as_widget(plotly_p, height = 500))

}

```

<br><br>

## Note: Static plots printed first, followed by interactive versions of a subset of acc data

--------------------------------------------------------------------------------

A random sample of 500000 acc readings is plotted interactively, along with all
the GPS fixes. A sample is plotted because otherwise the plot rendering and file
generation takes an inordinate amount of time and bloats the finished file.

```{r, results = 'asis', echo = FALSE}
cat("![](",saved_plots[1],")")
p_l[[ 1 ]]
```

<br><br><br><br><br><br>

--------------------------------------------------------------------------------

```{r, results = 'asis', echo = FALSE}
cat("![](",saved_plots[2],")")
p_l[[ 2 ]]
```


<br><br><br><br><br><br>

--------------------------------------------------------------------------------


```{r, results = 'asis', echo = FALSE}
cat("![](",saved_plots[3],")")
p_l[[ 3 ]]
```


<br><br><br><br><br><br>

--------------------------------------------------------------------------------

```{r, results = 'asis', echo = FALSE}
cat("![](",saved_plots[4],")")
p_l[[ 4 ]]
```


<br><br><br><br><br><br>

--------------------------------------------------------------------------------

```{r, results = 'asis', echo = FALSE}
cat("![](",saved_plots[5],")")
p_l[[ 5 ]]
```


<br><br><br><br><br><br>

--------------------------------------------------------------------------------

```{r, results = 'asis', echo = FALSE}
cat("![](",saved_plots[6],")")
p_l[[ 6 ]]
```


<br><br><br><br><br><br>

--------------------------------------------------------------------------------

```{r, results = 'asis', echo = FALSE}
cat("![](",saved_plots[7],")")
p_l[[ 7 ]]
```


<br><br><br><br><br><br>

--------------------------------------------------------------------------------

```{r, results = 'asis', echo = FALSE}
cat("![](",saved_plots[8],")")
p_l[[ 8 ]]
```

<br><br><br><br><br><br>

--------------------------------------------------------------------------------

# Session info

```{r}
sessionInfo()
```

